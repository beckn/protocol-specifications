# How to build the specification

The full specification can be found at `api/registry/build/registry.yaml`

This is an autogenerated file created by compiling two sets of components namely,

1. APIs : found at `api/registry/components/io`
2. Schema : found at `api/registry/components/schema`

The compilation flow is illustrated below

# Compilation steps

## Step 1 : Create the schema index file

- Go to the `api/registry/components/schema/` folder
- Create a file `index.yaml`. If already present, open it in a text editor
- It will contain a list of schema with $refs pointing to specific schema files in the current folder as shown below

```
Gps:
  $ref: "../../../../schema/Gps.yaml"

Location:
  $ref: "../../../../schema/Location.yaml"
...
```

- Ensure that each required schema has an entry in this file. If it is not present, it will not be compiled

## Step 2 : Create the unresolved OpenAPI file

- Go to the `api/registry/components` folder
- In this folder, create a file - `index.yaml`. If it is already present, open it in a text editor.
- In the file, you will see the following

```
openapi: 3.0.0
info:
  title: Beckn Protocol Registry Infrastructure API
  description: This document contains the API specification for the Registry infrastructure of a beckn-enabled network. The Registry API forms the trust layer of beckn protocol. When implemented, they enable creation of an infrastructure that allow trusted transactions between network participants to take place by means of digital signature authentication. The core infrastructure is called the Network Registry or simply, Registry. Any network participant that is listed on the registry can be assumed to have successfully passed the certfication and compliance process of the network, and hence be trusted to transact with. 
  version: "1.0.0"
security:
  - SubscriberAuth: []
paths:
  /lookup:
    description: Look up platforms listed on the network registry. This is a protected endpoint only accessible to network participants that have subscribed to the network (i.e Subscribers). Any subscriber can query the Registry by sending a `Lookup` object. The Registry will respond with all the platforms that match the lookup parameters. 
    post:
      tags:
        - Registry
      requestBody:
        content:
          application/json:
            schema:
              $ref : "./io/Lookup.yaml"
      responses:
        default:
          $ref: "./io/LookupResponse.yaml"

...

```

- As you can see, the `index.yaml` contains the unresolved Open API definitions with references to the APIs found in `api/registry/components/io/`
- Ensure each API definition in the `api/registry/components/io/` folder is referenced in this file. If it is not present, it will not be compiled.
- Once all API referencing is done, save this file and close it.

## Install swagger CLI

- Install the swagger command line tool using `npm`
- Note: you may need to use root privileges if installing it globally

```
sudo npm install -g swagger-cli
```

## Generate the resolved OpenAPI definition file

- Go to the root directory of this project i.e `protocol-specifications/`
- Run the following command

```
swagger-cli bundle api/registry/components/index.yaml --outfile api/registry/build/registry.yaml --type yaml
```

- If the command runs successfully, you should see an output like this,

```
Created api/registry/build/registry.yaml from api/registry/components/index.yaml
```

- Commit the changes and push the updated code
